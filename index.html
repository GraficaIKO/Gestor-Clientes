<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Clientes y Ganancias - Sincronizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .client-card:hover { transform: translateY(-4px); transition: all 0.3s ease; }
        .whatsapp-btn { background-color: #25D366; }
        .whatsapp-btn:hover { background-color: #128C7E; }
        .modal { display: none; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal.active { display: flex; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .tab-btn.active {
            border-bottom: 3px solid #6366f1;
            color: #6366f1;
        }

        .group-container {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        .group-container.collapsed { max-height: 0; }
        .group-container.expanded { max-height: 2000px; }
        
        .chart-container { position: relative; height: 350px; width: 100%; }

        /* Estilos para alertas de tiempo */
        .status-overdue { border-left: 4px solid #ef4444 !important; background-color: #fef2f2; }
        .status-today { border-left: 4px solid #f59e0b !important; background-color: #fffbeb; }
        .status-soon { border-left: 4px solid #10b981 !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">

    <!-- Header -->
    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <i class="fas fa-chart-line text-indigo-400"></i> Control de Ganancias
                    </h1>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto items-center">
                    <div class="relative w-full sm:w-64">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="Buscar local, contacto o grupo..." 
                               class="w-full pl-10 pr-4 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white text-sm">
                    </div>
                    <button id="openModalBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors w-full sm:w-auto justify-center text-sm">
                        <i class="fas fa-plus"></i> Nuevo Cliente
                    </button>
                </div>
            </div>
            
            <nav class="flex gap-8 mt-6">
                <button onclick="switchTab('analytics')" id="tab-analytics" class="tab-btn active pb-2 font-bold text-xs uppercase tracking-wider transition-all">Análisis</button>
                <button onclick="switchTab('clients')" id="tab-clients" class="tab-btn pb-2 font-bold text-xs uppercase tracking-wider transition-all">Clientes y Grupos</button>
                <button onclick="switchTab('orders')" id="tab-orders" class="tab-btn pb-2 font-bold text-xs uppercase tracking-wider transition-all">Tablero de Pedidos</button>
            </nav>
        </div>
    </header>

    <!-- Métricas Principales -->
    <section class="max-w-7xl mx-auto px-6 pt-8">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-1">Locales Activos</p>
                <h3 class="text-3xl font-bold text-slate-800" id="totalClients">0</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 border-l-4 border-l-emerald-500">
                <p class="text-emerald-600 text-[10px] font-bold uppercase tracking-wider mb-1">Ganancia Realizada</p>
                <h3 class="text-3xl font-black text-slate-900" id="netProfit">$0</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 border-l-4 border-l-amber-500">
                <p class="text-amber-600 text-[10px] font-bold uppercase tracking-wider mb-1">Proyectada (Pendientes)</p>
                <h3 class="text-3xl font-black text-slate-900" id="projectedProfit">$0</h3>
            </div>
        </div>

        <!-- VISTA: ANÁLISIS -->
        <div id="view-analytics" class="tab-view space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Evolución de Ganancias</h2>
                        <p class="text-sm text-gray-500">Visualiza tu crecimiento por periodos</p>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-xl">
                        <button onclick="changeChartPeriod('weekly')" id="btn-period-weekly" class="px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all bg-white shadow-sm text-indigo-600 uppercase">Por Semanas</button>
                        <button onclick="changeChartPeriod('monthly')" id="btn-period-monthly" class="px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all text-gray-500 uppercase">Por Meses</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>

        <!-- VISTA: CLIENTES -->
        <div id="view-clients" class="tab-view hidden">
            <div id="clientsGrid" class="space-y-6"></div>
        </div>

        <!-- VISTA: PEDIDOS -->
        <div id="view-orders" class="tab-view hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <h3 class="font-bold text-amber-700 mb-4 flex items-center justify-between uppercase text-[10px] tracking-widest">
                        <span><i class="fas fa-clock mr-2"></i> PENDIENTES</span>
                        <span id="count-pendiente" class="bg-amber-200 text-amber-800 px-2 py-0.5 rounded-full">0</span>
                    </h3>
                    <div id="list-pendiente" class="space-y-4"></div>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <h3 class="font-bold text-emerald-700 mb-4 flex items-center justify-between uppercase text-[10px] tracking-widest">
                        <span><i class="fas fa-check-circle mr-2"></i> COMPLETADOS</span>
                        <span id="count-completado" class="bg-emerald-200 text-emerald-800 px-2 py-0.5 rounded-full">0</span>
                    </h3>
                    <div id="list-completado" class="space-y-4"></div>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <h3 class="font-bold text-slate-600 mb-4 flex items-center justify-between uppercase text-[10px] tracking-widest">
                        <span><i class="fas fa-times-circle mr-2"></i> CANCELADOS</span>
                        <span id="count-cancelado" class="bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full">0</span>
                    </h3>
                    <div id="list-cancelado" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- MODALES -->
    <div id="confirmModal" class="modal fixed inset-0 z-[100] items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">¿Estás seguro?</h3>
            <p id="confirmMessage" class="text-sm text-gray-500 mb-6">Esta acción no se puede deshacer.</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-bold transition-colors">Cancelar</button>
                <button id="confirmActionBtn" class="flex-1 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition-colors">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="clientModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-900 p-4 text-white flex justify-between items-center shrink-0">
                <h2 id="modalTitle" class="font-bold text-lg">Agregar Cliente</h2>
                <button onclick="closeModals()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="clientForm" class="p-6 space-y-4 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="formId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre del Local</label>
                        <input type="text" id="formLocal" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre Personal</label>
                        <input type="text" id="formNombrePersonal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Grupo / Empresa</label>
                    <input type="text" id="formGrupo" list="groupList" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    <datalist id="groupList"></datalist>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Dirección del Local</label>
                    <input type="text" id="formDireccion" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Número de Teléfono</label>
                        <input type="text" id="formContacto" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                        <input type="email" id="formEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div class="pt-4 flex gap-3 sticky bottom-0 bg-white">
                    <button type="button" onclick="closeModals()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-bold">Cancelar</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-emerald-600 p-4 text-white flex justify-between items-center shrink-0">
                <h2 class="font-bold text-lg">Pedidos</h2>
                <button onclick="closeModals()" class="text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex flex-col md:flex-row overflow-hidden">
                <form id="orderForm" class="p-6 space-y-4 border-r border-gray-100 md:w-1/2 overflow-y-auto">
                    <input type="hidden" id="orderClientId">
                    <input type="hidden" id="orderEditId">
                    <div id="orderClientTitle" class="font-bold text-xs text-gray-400 uppercase mb-2 italic"></div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Producto</label>
                        <input type="text" id="orderProduct" required class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cobro ($)</label>
                            <input type="number" id="orderAmount" required class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Costo ($)</label>
                            <input type="number" id="orderCost" required class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fecha Entrega</label>
                        <input type="date" id="orderDeliveryDate" required class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estado</label>
                        <select id="orderStatus" class="w-full px-3 py-2 border rounded-lg text-sm bg-white">
                            <option value="pendiente">Pendiente</option>
                            <option value="completado">Completado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold transition-colors">Guardar Pedido</button>
                </form>
                <div class="p-6 md:w-1/2 bg-gray-50 overflow-y-auto custom-scrollbar">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-4">Historial de este cliente</h3>
                    <div id="orderHistory" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Variables de entorno inyectadas)
        const firebaseConfig = {
  apiKey: "AIzaSyAHDINPf_KvfMmxZihL4Bca9zd30jhvm8U",
  authDomain: "gestor-iko.firebaseapp.com",
  projectId: "gestor-iko",
  storageBucket: "gestor-iko.firebasestorage.app",
  messagingSenderId: "1002255229380",
  appId: "1:1002255229380:web:51e0386918bd8690e8c491"
};

        // --- DATA ---
        let clients = [];
        let orders = [];
        let chartInstance = null;
        let currentChartPeriod = 'weekly';
        let user = null;

        // --- FIREBASE SYNC ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) startSync();
        });

        function startSync() {
            if (!user) return;
            const clientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clients');
            const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');

            onSnapshot(clientsRef, (snapshot) => {
                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDatalist();
                render();
            }, (error) => console.error("Error sincronizando clientes:", error));

            onSnapshot(ordersRef, (snapshot) => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
                updateChartData();
                updateStats();
                updateBoard();
            }, (error) => console.error("Error sincronizando pedidos:", error));
        }

        // --- GLOBAL ACTIONS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        };

        window.toggleGroup = (gId) => {
            const content = document.getElementById(`content-${gId}`);
            const icon = document.getElementById(`icon-${gId}`);
            content.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            if(icon) icon.classList.toggle('rotate-180');
        };

        window.closeModals = () => {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            document.getElementById('clientForm').reset();
            document.getElementById('orderForm').reset();
            document.getElementById('formId').value = "";
            document.getElementById('orderEditId').value = "";
        };

        // UI Event Listeners
        document.getElementById('openModalBtn').onclick = () => {
            document.getElementById('modalTitle').textContent = "Agregar Cliente";
            document.getElementById('clientModal').classList.add('active');
        };

        document.getElementById('searchInput').oninput = () => render();

        // Forms Logic
        document.getElementById('clientForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!user) return;
            const id = document.getElementById('formId').value;
            const data = {
                local: document.getElementById('formLocal').value,
                nombrePersonal: document.getElementById('formNombrePersonal').value,
                grupo: document.getElementById('formGrupo').value,
                direccion: document.getElementById('formDireccion').value,
                contacto: document.getElementById('formContacto').value,
                email: document.getElementById('formEmail').value,
                updatedAt: Date.now()
            };

            const clientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clients');
            if (id) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', id), data);
            } else {
                await addDoc(clientsRef, { ...data, createdAt: Date.now() });
            }
            closeModals();
        };

        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!user) return;
            const editId = document.getElementById('orderEditId').value;
            const clientId = document.getElementById('orderClientId').value;
            const data = {
                clientId: clientId,
                producto: document.getElementById('orderProduct').value,
                cobro: parseFloat(document.getElementById('orderAmount').value),
                costo: parseFloat(document.getElementById('orderCost').value),
                fechaEntrega: document.getElementById('orderDeliveryDate').value,
                estado: document.getElementById('orderStatus').value,
                updatedAt: Date.now()
            };

            const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            if (editId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editId), data);
            } else {
                await addDoc(ordersRef, { ...data, createdAt: Date.now() });
            }
            document.getElementById('orderForm').reset();
            document.getElementById('orderEditId').value = "";
            document.getElementById('orderClientId').value = clientId; 
            refreshOrderHistory(clientId);
        };

        // Interaction Handlers
        window.handleEditClient = (id) => {
            const c = clients.find(cl => cl.id === id);
            if (!c) return;
            document.getElementById('formId').value = c.id;
            document.getElementById('formLocal').value = c.local;
            document.getElementById('formNombrePersonal').value = c.nombrePersonal || "";
            document.getElementById('formGrupo').value = c.grupo || "";
            document.getElementById('formDireccion').value = c.direccion || "";
            document.getElementById('formContacto').value = c.contacto || "";
            document.getElementById('formEmail').value = c.email || "";
            document.getElementById('modalTitle').textContent = "Editar Cliente";
            document.getElementById('clientModal').classList.add('active');
        };

        window.handleDeleteClient = (id) => {
            const c = clients.find(cl => cl.id === id);
            openConfirm(`¿Eliminar a "${c.local}" y sus pedidos?`, async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', id));
                const related = orders.filter(o => o.clientId === id);
                for (const r of related) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', r.id));
                }
            });
        };

        window.openOrderModal = (clientId) => {
            const client = clients.find(c => c.id === clientId);
            if(!client) return;
            document.getElementById('orderClientId').value = clientId;
            document.getElementById('orderClientTitle').textContent = client.local;
            refreshOrderHistory(clientId);
            document.getElementById('orderModal').classList.add('active');
        };

        window.handleEditOrder = (id) => {
            const o = orders.find(ord => ord.id === id);
            if (!o) return;
            document.getElementById('orderEditId').value = o.id;
            document.getElementById('orderClientId').value = o.clientId;
            document.getElementById('orderProduct').value = o.producto;
            document.getElementById('orderAmount').value = o.cobro;
            document.getElementById('orderCost').value = o.costo;
            document.getElementById('orderDeliveryDate').value = o.fechaEntrega;
            document.getElementById('orderStatus').value = o.estado;
            document.getElementById('orderModal').classList.add('active');
        };

        window.handleDeleteOrder = (id) => {
            openConfirm(`¿Eliminar este pedido?`, async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
            });
        };

        window.openConfirm = (msg, action) => {
            document.getElementById('confirmMessage').textContent = msg;
            document.getElementById('confirmModal').classList.add('active');
            document.getElementById('confirmActionBtn').onclick = async () => {
                await action();
                closeConfirm();
            };
        };

        window.closeConfirm = () => {
            document.getElementById('confirmModal').classList.remove('active');
        };

        // HELPERS
        function updateDatalist() {
            const dl = document.getElementById('groupList');
            const groups = [...new Set(clients.map(c => c.grupo).filter(g => g))];
            dl.innerHTML = groups.map(g => `<option value="${g}">`).join('');
        }

        function refreshOrderHistory(clientId) {
            const container = document.getElementById('orderHistory');
            const history = orders.filter(o => String(o.clientId) === String(clientId)).sort((a,b) => b.updatedAt - a.updatedAt);
            container.innerHTML = history.map(o => `
                <div class="bg-white p-3 rounded-lg border text-xs flex justify-between items-center">
                    <div>
                        <div class="font-bold">${o.producto}</div>
                        <div class="text-gray-400">$${o.cobro} - ${o.estado}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="handleEditOrder('${o.id}')" class="text-indigo-500 hover:bg-indigo-50 p-2 rounded"><i class="fas fa-edit"></i></button>
                        <button onclick="handleDeleteOrder('${o.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function getDaysDiff(targetDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const delivery = new Date(targetDate);
            delivery.setHours(24, 0, 0, 0); 
            return Math.ceil((delivery - today) / (1000 * 60 * 60 * 24));
        }

        function getTimeStatusHtml(date, status) {
            if (status !== 'pendiente') return `<span class="text-gray-400"><i class="far fa-calendar-alt mr-1"></i>${date}</span>`;
            const days = getDaysDiff(date);
            let colorClass = "text-emerald-600", text = `Faltan ${days} días`, icon = "fa-clock";
            if (days < 0) { colorClass = "text-red-600 font-black animate-pulse"; text = `VENCIDO (${Math.abs(days)}d)`; icon = "fa-exclamation-circle"; }
            else if (days === 0) { colorClass = "text-amber-600 font-bold"; text = "ENTREGA HOY"; icon = "fa-star"; }
            else if (days === 1) text = "Mañana";
            return `<span class="${colorClass} flex items-center gap-1"><i class="fas ${icon}"></i> ${text}</span>`;
        }

        function getCardClass(date, status) {
            if (status !== 'pendiente') return "";
            const days = getDaysDiff(date);
            if (days < 0) return "status-overdue";
            if (days === 0) return "status-today";
            if (days <= 3) return "status-soon";
            return "";
        }

        // --- RENDER ---
        function render() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('clientsGrid');
            if (!grid) return;
            grid.innerHTML = "";
            
            const groups = {};
            const individuals = [];
            clients.forEach(c => {
                if (c.grupo) {
                    if (!groups[c.grupo]) groups[c.grupo] = [];
                    groups[c.grupo].push(c);
                } else individuals.push(c);
            });

            Object.keys(groups).forEach(name => {
                const members = groups[name].filter(m => m.local.toLowerCase().includes(search) || name.toLowerCase().includes(search));
                if (members.length === 0) return;
                const gId = btoa(unescape(encodeURIComponent(name))).replace(/=/g, '');
                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-sm border border-indigo-50 overflow-hidden";
                div.innerHTML = `
                    <div onclick="toggleGroup('${gId}')" class="p-4 bg-indigo-50/30 flex justify-between items-center cursor-pointer hover:bg-indigo-50 transition-colors">
                        <span class="font-bold text-slate-700 uppercase text-[10px] tracking-widest"><i class="fas fa-building mr-2 text-indigo-500"></i> ${name}</span>
                        <i id="icon-${gId}" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                    </div>
                    <div id="content-${gId}" class="group-container collapsed px-4 pb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            ${members.map(m => getClientCardHtml(m)).join('')}
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });

            const indFiltered = individuals.filter(c => c.local.toLowerCase().includes(search));
            if (indFiltered.length > 0) {
                const indDiv = document.createElement('div');
                indDiv.className = "grid grid-cols-1 md:grid-cols-4 gap-4";
                indDiv.innerHTML = indFiltered.map(c => getClientCardHtml(c)).join('');
                grid.appendChild(indDiv);
            }
        }

        function getClientCardHtml(c) {
            const cOrders = orders.filter(o => String(o.clientId) === String(c.id));
            const profit = cOrders.filter(o => o.estado === 'completado').reduce((s, o) => s + (o.cobro - o.costo), 0);
            return `
                <div class="bg-white border rounded-xl overflow-hidden shadow-sm flex flex-col h-full client-card transition-all">
                    <div class="p-4 flex-1 cursor-pointer" onclick="openOrderModal('${c.id}')">
                        <h4 class="font-bold text-sm text-slate-800 truncate">${c.local}</h4>
                        <p class="text-[10px] text-gray-400 mb-2">${c.nombrePersonal || 'Responsable'}</p>
                        <div class="flex justify-between text-[10px] text-gray-500 border-t pt-2">
                            <span>Pedidos: <b>${cOrders.length}</b></span>
                            <span>Ganancia: <b class="text-emerald-600">$${profit}</b></span>
                        </div>
                    </div>
                    <div class="p-2 bg-gray-50 border-t flex gap-1">
                        <a href="https://wa.me/${c.contacto}" target="_blank" class="flex-1 whatsapp-btn text-white text-[10px] font-bold py-1.5 rounded text-center transition-colors"><i class="fab fa-whatsapp"></i> Chat</a>
                        <button onclick="handleEditClient('${c.id}')" class="w-10 bg-white border border-gray-200 text-gray-400 hover:text-indigo-500 rounded transition-colors"><i class="fas fa-edit text-xs"></i></button>
                        <button onclick="handleDeleteClient('${c.id}')" class="w-10 bg-white border border-gray-200 text-gray-400 hover:text-red-500 rounded transition-colors"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            const net = orders.filter(o => o.estado === 'completado').reduce((s, o) => s + (o.cobro - o.costo), 0);
            const proj = orders.filter(o => o.estado === 'pendiente').reduce((s, o) => s + (o.cobro - o.costo), 0);
            document.getElementById('netProfit').textContent = `$${net.toLocaleString()}`;
            document.getElementById('projectedProfit').textContent = `$${proj.toLocaleString()}`;
        }

        function updateBoard() {
            const statuses = ['pendiente', 'completado', 'cancelado'];
            statuses.forEach(status => {
                const list = document.getElementById(`list-${status}`);
                const count = document.getElementById(`count-${status}`);
                const filtered = orders.filter(o => o.estado === status).sort((a,b) => new Date(a.fechaEntrega) - new Date(b.fechaEntrega));
                
                count.textContent = filtered.length;
                list.innerHTML = filtered.map(o => {
                    const client = clients.find(c => String(c.id) === String(o.clientId));
                    return `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 ${getCardClass(o.fechaEntrega, o.estado)}">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-xs text-indigo-600 truncate uppercase tracking-tighter">${client ? client.local : 'Desconocido'}</h4>
                                <div class="flex gap-2">
                                    <button onclick="handleEditOrder('${o.id}')" class="text-gray-300 hover:text-indigo-500"><i class="fas fa-edit text-[10px]"></i></button>
                                </div>
                            </div>
                            <div class="text-sm font-bold text-slate-800 mb-1">${o.producto}</div>
                            <div class="flex justify-between items-center text-[10px]">
                                ${getTimeStatusHtml(o.fechaEntrega, o.estado)}
                                <span class="font-black text-slate-700">$${o.cobro}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // --- CHART LOGIC ---
        window.changeChartPeriod = (p) => {
            currentChartPeriod = p;
            document.getElementById('btn-period-weekly').className = p === 'weekly' ? 'px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all bg-white shadow-sm text-indigo-600 uppercase' : 'px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all text-gray-500 uppercase';
            document.getElementById('btn-period-monthly').className = p === 'monthly' ? 'px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all bg-white shadow-sm text-indigo-600 uppercase' : 'px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all text-gray-500 uppercase';
            updateChartData();
        };

        function updateChartData() {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;

            const completed = orders.filter(o => o.estado === 'completado');
            let labels = [];
            let dataPoints = [];

            if (currentChartPeriod === 'weekly') {
                const now = new Date();
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(now.getDate() - (i * 7));
                    const start = new Date(d); start.setDate(d.getDate() - d.getDay());
                    const end = new Date(start); end.setDate(start.getDate() + 6);
                    labels.push(`${start.getDate()}/${start.getMonth()+1}`);
                    const sum = completed.filter(o => {
                        const od = new Date(o.fechaEntrega);
                        return od >= start && od <= end;
                    }).reduce((s, o) => s + (o.cobro - o.costo), 0);
                    dataPoints.push(sum);
                }
            } else {
                const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const now = new Date();
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(months[d.getMonth()]);
                    const sum = completed.filter(o => {
                        const od = new Date(o.fechaEntrega);
                        return od.getMonth() === d.getMonth() && od.getFullYear() === d.getFullYear();
                    }).reduce((s, o) => s + (o.cobro - o.costo), 0);
                    dataPoints.push(sum);
                }
            }

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Ganancia ($)',
                        data: dataPoints,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#6366f1',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    </script>
</body>
</html>
